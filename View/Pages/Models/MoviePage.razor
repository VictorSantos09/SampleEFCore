@page "/movie"

<MudButton Class="mb-5" Color="Color.Primary" Variant="Variant.Filled" OnClick="() => OpenAddDialog()">
    <MudIcon Icon="@Icons.Material.Filled.Add" />
    Adicionar
</MudButton>

<MudTable Items="@_movies" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_isLoading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>Titulo</MudTh>
        <MudTh>Descrição</MudTh>
        <MudTh>Gênero</MudTh>
        <MudTh>Remover</MudTh>
        <MudTh>Editar</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Titulo">
            @context.Title
        </MudTd>
        <MudTd DataLabel="Descrição">
            @context.Description
        </MudTd>
        <MudTd DataLabel="Gênero">
            @context.Genre.Name
        </MudTd>
        <MudTd DataLabel="Remover">
            <MudIconButton @onclick="() => Delete(context.Id)" Icon="@Icons.Filled.Delete"></MudIconButton>
        </MudTd>
        <MudTd DataLabel="Editar">
            <MudIconButton @onclick="() => OpenEditDialog(context)" Icon="@Icons.Filled.Edit"></MudIconButton>
        </MudTd>
    </RowTemplate>
</MudTable>

@if (_movies.Any() == false)
{
    <MudAlert Severity="Severity.Info">Nenhum filme cadastrado</MudAlert>
}

@code {
    [Inject]
    private IService<MovieModel> MovieService { get; set; }
    [Inject]
    private IDialogService DialogService { get; set; }
    [Inject]
    public IService<GenreModel> GenreService { get; set; }
    private IEnumerable<MovieModel> _movies = new List<MovieModel>();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _movies = await MovieService.GetAllAsync();
        _isLoading = false;
    }
    private async Task Delete(int id)
    {
        await MovieService.DeleteAsync(id);
        await OnInitializedAsync();
    }

    private void OpenAddDialog()
    {
        DialogOptions options = new DialogOptions() { CloseButton = true };
        DialogService.Show<AddMovieDialog>("Adicionar Filme", options);
    }

    private async Task OpenEditDialog(MovieModel movie)
    {
        DialogOptions options = new DialogOptions() { CloseButton = true };

        var genres = await GenreService.GetAllAsync();
        DialogParameters parameters = new();
        parameters.Add("Movie", movie);
        parameters.Add("Genres", genres);

        DialogService.Show(typeof(EditMovieDialog), "Editar Filme", parameters, options);
    }
}
